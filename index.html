<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI聊天助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#722ED1',
            neutral: {
              100: '#F5F7FA',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .message-appear {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .cursor-blink {
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        from,
        to {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }
      .code-block-container {
        position: relative;
        margin: 1rem 0;
      }
      .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: #1E1E1E;
        border-radius: 0.5rem 0.5rem 0 0;
        color: white;
        font-size: 0.875rem;
      }
      .code-lang {
        font-weight: 500;
      }
      .copy-btn {
        padding: 0.25rem 0.75rem;
        background-color: #333333;
        color: white;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        transition: all 0.2s ease;
      }
      .copy-btn:hover {
        background-color: #444444;
      }
      .copy-btn.copied {
        background-color: rgba(76, 175, 80, 0.8);
      }
      .line-numbers {
        display: inline-block;
        width: 2rem;
        text-align: right;
        padding-right: 0.5rem;
        margin-right: 0.5rem;
        border-right: 1px solid #444;
        user-select: none;
        color: #888;
      }
      .katex {
        font-size: 1em !important;
      }
    }
  </style>
</head>

<body class="bg-neutral-100 font-inter min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-10 flex items-center justify-between px-4 py-3">
    <div class="flex items-center space-x-2">
      <i class="fa-solid fa-comments text-primary text-2xl"></i>
      <h1 class="text-xl font-bold text-neutral-700" id="title">AI聊天助手</h1>
    </div>
    <div class="flex items-center space-x-2">
      <button id="settingsBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
        <i class="fa-solid fa-cog text-neutral-500"></i>
      </button>
      <button id="langBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
        <span id="langText">中文</span>
      </button>
      <button id="clearContextBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
        <i class="fa-solid fa-trash text-neutral-500"></i>
      </button>
      <a href="https://github.com/kissyous" target="_blank" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
        <i class="fa-brands fa-github text-neutral-500 text-xl"></i>
      </a>
    </div>
  </header>

  <!-- 设置面板 (默认隐藏) -->
  <div id="settingsPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto my-8 p-6 transform transition-all duration-300 scale-95 opacity-0" id="settingsContent">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-neutral-700" id="settingsTitle">设置</h2>
        <button id="closeSettings" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
          <i class="fa-solid fa-times text-neutral-500"></i>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label for="apiKey" class="block text-sm font-medium text-neutral-700 mb-1" id="apiKeyLabel">API Key</label>
          <input type="password" id="apiKey" class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" value="sk-qjnjsqvsidysqwcjffocrfylewuhrulwhxybmswrjclejmby">
        </div>
        <div>
          <label for="model" class="block text-sm font-medium text-neutral-700 mb-1" id="modelLabel">模型选择</label>
          <select id="model" class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <option value="deepseek-ai/DeepSeek-V3">DeepSeek-V3</option>
                        <option value="Qwen/Qwen2.5-Coder-32B-Instruct">Qwen2.5-Coder-32B-Instruct</option>
                        <option value="THUDM/GLM-4-32B-0414">THUDM/GLM-4-32B-0414</option>
                        <option value="Qwen/Qwen2.5-72B-Instruct-128K">Qwen/Qwen2.5-72B-Instruct-128K</option>
                        <option value="Qwen/Qwen3-32B">Qwen/Qwen3-32B</option>
                        <option value="Qwen/Qwen3-235B-A22B-Instruct-2507">Qwen/Qwen3-235B-A22B-Instruct-2507</option>
                        <option value="baidu/ERNIE-4.5-300B-A47B">baidu/ERNIE-4.5-300B-A47B</option>
                        <option value="moonshotai/Kimi-K2-Instruct">moonshotai/Kimi-K2-Instruct</option>
                        <option value="ascend-tribe/pangu-pro-moe">ascend-tribe/pangu-pro-moe</option>
                        <option value="tencent/Hunyuan-A13B-Instruct">tencent/Hunyuan-A13B-Instruct</option>
                        <option value="MiniMaxAI/MiniMax-M1-80k">MiniMaxAI/MiniMax-M1-80k</option>
                        <option value="Tongyi-Zhiwen/QwenLong-L1-32B">Tongyi-Zhiwen/QwenLong-L1-32B</option>
                        <option value="Qwen/Qwen3-30B-A3B">Qwen/Qwen3-30B-A3B</option>
                        <option value="Qwen/Qwen3-14B">Qwen/Qwen3-14B</option>
                        <option value="Qwen/Qwen3-8B">Qwen/Qwen3-8B</option>
                        <option value="Qwen/Qwen3-235B-A22B">Qwen/Qwen3-235B-A22B</option>
                        <option value="THUDM/GLM-Z1-32B-0414">THUDM/GLM-Z1-32B-0414</option>
                        <option value="THUDM/GLM-Z1-Rumination-32B-0414">THUDM/GLM-Z1-Rumination-32B-0414</option>
                        <option value="THUDM/GLM-4-9B-0414">THUDM/GLM-4-9B-0414</option>
                        <option value="Qwen/QwQ-32B">Qwen/QwQ-32B</option>
                        <option value="deepseek-ai/DeepSeek-R1">deepseek-ai/DeepSeek-R1</option>
                        <option value="deepseek-ai/DeepSeek-R1-0528-Qwen3-8B">deepseek-ai/DeepSeek-R1-0528-Qwen3-8B</option>
                        <option value="deepseek-ai/DeepSeek-R1-Distill-Qwen-32B">deepseek-ai/DeepSeek-R1-Distill-Qwen-32B</option>
                        <option value="deepseek-ai/DeepSeek-R1-Distill-Qwen-14B">deepseek-ai/DeepSeek-R1-Distill-Qwen-14B</option>
                        <option value="deepseek-ai/DeepSeek-R1-Distill-Qwen-7B">deepseek-ai/DeepSeek-R1-Distill-Qwen-7B</option>
                        <option value="deepseek-ai/DeepSeek-V2.5">deepseek-ai/DeepSeek-V2.5</option>
                        <option value="Qwen/Qwen2.5-72B-Instruct">Qwen/Qwen2.5-72B-Instruct</option>
                        <option value="Qwen/Qwen2.5-32B-Instruct">Qwen/Qwen2.5-32B-Instruct</option>
                        <option value="Qwen/Qwen2.5-14B-Instruct">Qwen/Qwen2.5-14B-Instruct</option>
                        <option value="Qwen/Qwen2.5-7B-Instruct">Qwen/Qwen2.5-7B-Instruct</option>
                        <option value="Qwen/Qwen2.5-Coder-7B-Instruct">Qwen/Qwen2.5-Coder-7B-Instruct</option>
                        <option value="Qwen/Qwen2-7B-Instruct">Qwen/Qwen2-7B-Instruct</option>
                        <option value="TeleAI/TeleChat2">TeleAI/TeleChat2</option>
                        <option value="THUDM/glm-4-9b-chat">THUDM/glm-4-9b-chat</option>
                        <option value="Vendor-A/Qwen/Qwen2.5-72B-Instruct">Vendor-A/Qwen/Qwen2.5-72B-Instruct</option>
                        <option value="internlm/internlm2_5-7b-chat">internlm/internlm2_5-7b-chat</option>
          </select>
        </div>
        <div>
          <label for="temperature" class="block text-sm font-medium text-neutral-700 mb-1" id="temperatureLabel">Temperature (0.0 - 2.0)</label>
          <input type="range" id="temperature" min="0.0" max="2.0" step="0.1" value="0.7" class="w-full accent-primary">
          <div class="flex justify-between text-xs text-neutral-500 mt-1">
            <span id="precisionText">精确</span>
            <span id="tempValue">0.7</span>
            <span id="creativityText">创意</span>
          </div>
        </div>
        <div>
          <label class="flex items-center space-x-2">
            <input type="checkbox" id="streamingMode" class="accent-primary" checked>
            <span class="text-sm font-medium text-neutral-700" id="streamingModeLabel">启用流式响应</span>
          </label>
        </div>
        <div>
          <label for="prompt" class="block text-sm font-medium text-neutral-700 mb-1" id="promptLabel">提示词</label>
          <input type="text" id="prompt" class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="输入提示词">
        </div>
      </div>
      <div class="mt-6">
        <button id="saveSettings" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-md transition-colors">
          <span id="saveSettingsText">保存设置</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 主聊天区域 -->
  <div id="chatContainer" class="bg-white rounded-xl shadow-md overflow-hidden h-[calc(100vh-64px)] flex flex-col max-w-full mx-auto">
    <!-- 聊天消息区域 -->
    <div id="messages" class="flex-grow p-4 overflow-y-auto scrollbar-hide space-y-4">
      <!-- 欢迎消息 -->
      <div class="message-appear">
        <div class="flex items-start space-x-3">
          <div class="bg-primary/10 text-primary rounded-full p-2 flex-shrink-0">
            <i class="fa-solid fa-robot"></i>
          </div>
          <div class="bg-neutral-100 rounded-lg rounded-tl-none p-4 max-w-[85%]">
            <p class="text-neutral-700" id="welcomeMessage">欢迎使用 AI 聊天助手！如果觉得好用，给我的GitHub点一颗小星星吧！</p>
          </div>
        </div>
      </div>
      <!-- 错误消息示例 (默认隐藏) -->
      <div id="errorMessage" class="hidden message-appear">
        <div class="flex items-center space-x-3">
          <div class="bg-red-100 text-red-500 rounded-full p-2 flex-shrink-0">
            <i class="fa-solid fa-exclamation-triangle"></i>
          </div>
          <div class="bg-red-50 rounded-lg rounded-tl-none p-4 max-w-[85%]">
            <p id="errorText" class="text-red-700"></p>
          </div>
        </div>
      </div>
    </div>
    <!-- 分隔线 -->
    <div class="border-t border-neutral-200"></div>
    <!-- 输入区域 -->
    <div class="p-4">
      <div class="relative">
        <textarea id="userInput" placeholder="输入您的问题..." class="w-full px-4 py-3 pr-24 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none h-20" rows="1"></textarea>
        <div class="absolute right-3 bottom-3 flex space-x-2">
          <button id="stopBtn" class="bg-red-500 hover:bg-red-600 text-white rounded-full p-2 transition-colors hidden">
            <i class="fa-solid fa-stop"></i>
          </button>
          <button id="sendBtn" class="bg-primary hover:bg-primary/90 text-white rounded-full p-2 transition-colors">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
      <div class="mt-2 text-xs text-neutral-400 flex justify-between">
        <span id="markdownSupportText">powered by Kevin</span>
        <span id="charCount">0/2000</span>
      </div>
    </div>
  </div>

  <script>
    // 初始化变量
    let apiKey = "sk-nxtkicnfrtckjxjtujhyzpdklkikqsasfuyllwabqevphqci";
    let model = "Qwen/Qwen2.5-14B-Instruct";
    let temperature = 0.7;
    let streamingMode = true;
    let conversationHistory = [];
    let currentStreamingMessage = null;
    let controller = null; // 用于取消请求的 AbortController
    let saveTimer = null;
    let isChinese = true;
    let prompt = '';

    // 中英文文本映射
    const langTexts = {
      zh: {
        title: 'AI聊天助手',
        settingsTitle: '设置',
        apiKeyLabel: 'API Key',
        modelLabel: '模型选择',
        temperatureLabel: 'Temperature (0.0 - 2.0)',
        precisionText: '精确',
        creativityText: '创意',
        streamingModeLabel: '启用流式响应',
        promptLabel: '提示词',
        saveSettingsText: '保存设置',
        welcomeMessage: '如果觉得好用，给我的GitHub点一颗star吧！本站提供限量额度的免费api密钥，请勿滥用。',
        markdownSupportText: '支持 Markdown 语法、数学公式和代码块',
        langText: '中文',
        copyBtn: '复制',
        copiedBtn: '已复制',
      },
      en: {
        title: 'AI Chat Assistant',
        settingsTitle: 'Settings',
        apiKeyLabel: 'API Key',
        modelLabel: 'Model Selection',
        temperatureLabel: 'Temperature (0.0 - 2.0)',
        precisionText: 'Precise',
        creativityText: 'Creative',
        streamingModeLabel: 'Enable Streaming Response',
        promptLabel: 'Prompt',
        saveSettingsText: 'Save Settings',
        welcomeMessage: 'Welcome to the AI chat assistant! I am an intelligent assistant by Kevin. How can I help you?',
        markdownSupportText: 'Supports Markdown syntax, mathematical formulas, and code blocks',
        langText: 'English',
        copyBtn: 'Copy',
        copiedBtn: 'Copied',
      }
    };

    // DOM 元素
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const messages = document.getElementById('messages');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const charCount = document.getElementById('charCount');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsContent = document.getElementById('settingsContent');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettings = document.getElementById('saveSettings');
    const langBtn = document.getElementById('langBtn');
    const clearContextBtn = document.getElementById('clearContextBtn');
    const promptInput = document.getElementById('prompt');

    // 页面加载时尝试恢复聊天历史
    function loadConversationHistory() {
      const savedHistory = localStorage.getItem('conversationHistory');
      if (savedHistory) {
        try {
          conversationHistory = JSON.parse(savedHistory);
          // 渲染历史消息
          conversationHistory.forEach(msg => {
            appendMessage(msg.role === 'user' ? 'user' : 'ai', msg.content);
          });
          scrollToBottom();
          // 渲染所有数学公式
          renderMathInElement(messages);
        } catch (e) {
          console.error('Failed to parse saved conversation history', e);
        }
      }
    }

    // 保存聊天历史到本地存储
    function saveConversationHistory() {
      if (saveTimer) clearTimeout(saveTimer);

      // 延迟保存，避免频繁操作
      saveTimer = setTimeout(() => {
        try {
          localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
        } catch (e) {
          console.error('Failed to save conversation history', e);
        }
      }, 1000);
    }

    // 发送消息
    function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      // 清空输入框并恢复高度
      userInput.value = '';
      userInput.style.height = 'auto';
      charCount.textContent = '0/2000';

      // 添加用户消息到聊天界面
      appendMessage('user', message);

      // 添加到对话历史
      conversationHistory.push({
        role: 'user',
        content: message
      });

      // 保存聊天记录
      saveConversationHistory();

      // 切换按钮状态
      sendBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');

      // 滚动到底部
      scrollToBottom();

      // 调用 API
      callAIAPI(message);
    }

    // 强制停止
    function stopGeneration() {
      // 取消请求
      if (controller) {
        controller.abort();
        controller = null;
      }

      // 结束流式响应
      finishStreamingResponse();

      // 切换按钮状态
      sendBtn.classList.remove('hidden');
      stopBtn.classList.add('hidden');

      // 保存聊天记录
      saveConversationHistory();

      // 滚动到底部
      scrollToBottom();
    }

    // 追加消息到聊天界面
    function appendMessage(sender, content, isStreaming = false) {
      // 过滤掉###标记
      content = content.replace(/###/g, '');

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-appear';

      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="flex items-start justify-end space-x-3">
            <div class="bg-primary text-white rounded-lg rounded-tr-none p-4 max-w-[85%]">
              <p class="break-words">${formatMessage(content)}</p>
            </div>
            <div class="bg-neutral-200 text-neutral-700 rounded-full p-2 flex-shrink-0">
              <i class="fa-solid fa-user"></i>
            </div>
          </div>
        `;
        messages.appendChild(messageDiv);
      } else if (sender === 'ai') {
        if (!isStreaming) {
          // 非流式响应，直接添加完整消息
          messageDiv.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="bg-primary/10 text-primary rounded-full p-2 flex-shrink-0">
                <i class="fa-solid fa-robot"></i>
              </div>
              <div class="bg-neutral-100 rounded-lg rounded-tl-none p-4 max-w-[85%]">
                <p class="break-words">${formatMessage(content)}</p>
              </div>
            </div>
          `;
          messages.appendChild(messageDiv);
          // 渲染数学公式
          renderMathInElement(messageDiv);
        } else {
          // 流式响应，创建可更新的消息容器
          messageDiv.id = 'streaming-response';
          messageDiv.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="bg-primary/10 text-primary rounded-full p-2 flex-shrink-0">
                <i class="fa-solid fa-robot"></i>
              </div>
              <div class="bg-neutral-100 rounded-lg rounded-tl-none p-4 max-w-[85%]">
                <p id="streaming-content" class="break-words">${formatMessage(content)}</p>
                <span id="cursor" class="cursor-blink">|</span>
              </div>
            </div>
          `;
          messages.appendChild(messageDiv);
          currentStreamingMessage = {
            element: messageDiv,
            contentElement: messageDiv.querySelector('#streaming-content'),
            content: content
          };
        }
      }
    }

    // 更新流式响应内容
    function updateStreamingResponse(content) {
      if (!currentStreamingMessage) return;

      // 过滤掉###标记
      content = content.replace(/###/g, '');

      currentStreamingMessage.content = content;
      currentStreamingMessage.contentElement.innerHTML = formatMessage(content);
      scrollToBottom();
    }

    // 结束流式响应
    function finishStreamingResponse() {
      if (!currentStreamingMessage) return;

      // 移除光标
      const cursor = currentStreamingMessage.element.querySelector('#cursor');
      if (cursor) {
        cursor.remove();
      }

      // 添加到对话历史
      if (currentStreamingMessage.content.trim()) {
        conversationHistory.push({
          role: 'assistant',
          content: currentStreamingMessage.content
        });

        // 保存聊天记录
        saveConversationHistory();
        
        // 渲染数学公式
        renderMathInElement(currentStreamingMessage.element);
      }

      // 重置当前流式消息
      currentStreamingMessage = null;
    }

    // 格式化消息（简单的 Markdown 支持）
    function formatMessage(text) {
      // 转义 HTML
      text = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // 支持行内数学公式（$...$）
      text = text.replace(/\$([^$]+)\$\s*/g, '<span class="math inline">$1</span>');
      
      // 支持块级数学公式（$$...$$）
      text = text.replace(/\$\$([\s\S]+?)\$\$\s*/g, '<div class="math display">$1</div>');

      // 支持代码块
      text = text.replace(/```([\s\S]*?)```/g, (match, code) => {
        // 尝试检测语言标签
        let lang = '';
        let codeContent = code;

        const langMatch = code.match(/^(\w+)\n/);
        if (langMatch) {
          lang = langMatch[1];
          codeContent = code.replace(/^\w+\n/, '');
        }

        // 生成行号
        const lines = codeContent.split('\n');
        let lineNumbersHTML = '';
        let codeWithoutLineNumbers = '';
        
        lines.forEach((line, index) => {
          lineNumbersHTML += `<div>${index + 1}</div>`;
          codeWithoutLineNumbers += `<div>${line}</div>`;
        });

        // 获取当前语言的按钮文本
        const copyText = langTexts[isChinese? 'zh' : 'en'].copyBtn;

        return `
          <div class="code-block-container">
            <div class="code-header">
              <div class="code-lang">${lang || 'code'}</div>
              <button class="copy-btn" data-code="${escapeHTML(codeContent)}">
                <i class="fa-regular fa-copy"></i>
                <span>${copyText}</span>
              </button>
            </div>
            <div class="code-content bg-neutral-800 text-white rounded-b-lg overflow-x-auto">
              <div class="flex">
                <div class="line-numbers">${lineNumbersHTML}</div>
                <pre class="flex-1 p-3"><code class="language-${lang}">${codeWithoutLineNumbers}</code></pre>
              </div>
            </div>
          </div>
        `;
      });

      // 支持行内代码
      text = text.replace(/`(.*?)`/g, '<code class="bg-neutral-200 px-1 py-0.5 rounded text-sm">$1</code>');

      // 支持粗体
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

      // 支持斜体
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

      // 支持换行（但保留原始换行符，不转换为<br>）
      return text;
    }

    // 辅助函数：转义HTML特殊字符
    function escapeHTML(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // 使用KaTeX渲染数学公式
    function renderMathInElement(element) {
      if (window.katex) {
        const mathElements = element.querySelectorAll('.math');
        mathElements.forEach(mathElement => {
          try {
            const math = mathElement.textContent;
            const displayMode = mathElement.classList.contains('display');
            
            katex.render(math, mathElement, {
              throwOnError: false,
              displayMode: displayMode,
              strict: 'ignore'
            });
          } catch (e) {
            console.error('Failed to render math:', e);
          }
        });
      }
    }

    // 滚动到底部
    function scrollToBottom() {
      messages.scrollTop = messages.scrollHeight;
    }

    // 调用 AI API
    async function callAIAPI(message) {
      // 创建 AbortController 用于取消请求
      controller = new AbortController();
      const signal = controller.signal;

      try {
        // 准备请求数据
        const requestData = {
          model: model,
          messages: conversationHistory,
          temperature: temperature,
          stream: streamingMode
        };

        if (prompt) {
          requestData.messages.unshift({
            role: 'system',
            content: prompt
          });
        }

        // 发送请求
        const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify(requestData),
          signal: signal
        });

        if (!response.ok) {
          throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
        }

        // 处理流式响应
        if (streamingMode) {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let accumulatedText = '';

          // 创建流式响应的初始消息
          appendMessage('ai', '', true);

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              finishStreamingResponse();
              break;
            }

            // 解码数据
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n').filter(line => line.trim() !== '');

            // 处理每个数据块
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.substring(6);
                if (data === '[DONE]') continue;

                try {
                  const parsed = JSON.parse(data);
                  if (parsed.choices && parsed.choices[0].delta && parsed.choices[0].delta.content) {
                    accumulatedText += parsed.choices[0].delta.content;
                    updateStreamingResponse(accumulatedText);
                  }
                } catch (e) {
                  console.error('Failed to parse stream chunk', e);
                }
              }
            }
          }
        } else {
          // 处理非流式响应
          const data = await response.json();
          if (data.choices && data.choices[0].message && data.choices[0].message.content) {
            const content = data.choices[0].message.content;
            appendMessage('ai', content);

            // 添加到对话历史
            conversationHistory.push({
              role: 'assistant',
              content: content
            });

            // 保存聊天记录
            saveConversationHistory();
          } else {
            throw new Error('API返回格式异常');
          }
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          console.log('请求被用户取消');
        } else {
          console.error('API调用出错:', error);
          showError(`API调用出错: ${error.message}`);
        }
      } finally {
        // 恢复按钮状态
        sendBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
        controller = null;
      }
    }

    // 显示错误消息
    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      scrollToBottom();

      // 3秒后自动隐藏错误消息
      setTimeout(() => {
        errorMessage.classList.add('hidden');
      }, 3000);
    }

    // 调整输入框高度
    function adjustTextareaHeight() {
      userInput.style.height = 'auto';
      userInput.style.height = (userInput.scrollHeight > 100 ? 100 : userInput.scrollHeight) + 'px';
      charCount.textContent = `${userInput.value.length}/2000`;

      // 限制最大长度
      if (userInput.value.length > 2000) {
        userInput.value = userInput.value.substring(0, 2000);
        charCount.textContent = '2000/2000';
      }
    }

    // 设置面板动画
    function animateSettingsPanel(show) {
      if (show) {
        settingsPanel.classList.remove('hidden');
        setTimeout(() => {
          settingsContent.classList.remove('scale-95', 'opacity-0');
          settingsContent.classList.add('scale-100', 'opacity-100');
        }, 10);
      } else {
        settingsContent.classList.remove('scale-100', 'opacity-100');
        settingsContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          settingsPanel.classList.add('hidden');
        }, 300);
      }
    }

    // 初始化设置面板值
    function initSettingsPanel() {
      document.getElementById('model').value = model;
      document.getElementById('temperature').value = temperature;
      document.getElementById('tempValue').textContent = temperature;
      document.getElementById('streamingMode').checked = streamingMode;
      promptInput.value = prompt;
    }

    // 保存设置
    function saveSettingsHandler() {
      apiKey = document.getElementById('apiKey').value;
      model = document.getElementById('model').value;
      temperature = parseFloat(document.getElementById('temperature').value);
      streamingMode = document.getElementById('streamingMode').checked;
      prompt = promptInput.value;
      
      // 更新温度显示
      document.getElementById('tempValue').textContent = temperature;
      
      // 关闭设置面板
      animateSettingsPanel(false);
    }

    // 切换语言
    function toggleLanguage() {
      isChinese = !isChinese;
      const texts = langTexts[isChinese ? 'zh' : 'en'];
      
      // 更新界面文本
      document.getElementById('title').textContent = texts.title;
      document.getElementById('settingsTitle').textContent = texts.settingsTitle;
      document.getElementById('apiKeyLabel').textContent = texts.apiKeyLabel;
      document.getElementById('modelLabel').textContent = texts.modelLabel;
      document.getElementById('temperatureLabel').textContent = texts.temperatureLabel;
      document.getElementById('precisionText').textContent = texts.precisionText;
      document.getElementById('creativityText').textContent = texts.creativityText;
      document.getElementById('streamingModeLabel').textContent = texts.streamingModeLabel;
      document.getElementById('promptLabel').textContent = texts.promptLabel;
      document.getElementById('saveSettingsText').textContent = texts.saveSettingsText;
      document.getElementById('welcomeMessage').textContent = texts.welcomeMessage;
      document.getElementById('markdownSupportText').textContent = texts.markdownSupportText;
      document.getElementById('langText').textContent = texts.langText;
      
      // 更新代码块中的按钮文本
      document.querySelectorAll('.copy-btn span').forEach(el => {
        el.textContent = texts.copyBtn;
      });
    }

    // 清空对话上下文
    function clearConversationContext() {
      if (confirm(isChinese ? '确定要清空对话历史吗？' : 'Are you sure you want to clear the conversation history?')) {
        conversationHistory = [];
        localStorage.removeItem('conversationHistory');
        messages.innerHTML = '';
        
        // 添加欢迎消息
        appendMessage('ai', isChinese ? '欢迎使用 AI 聊天助手！' : 'Welcome to the AI chat assistant!');
      }
    }

    // 复制代码
    function copyCodeToClipboard(btn) {
      const code = btn.getAttribute('data-code');
      
      // 使用现代Clipboard API
      navigator.clipboard.writeText(code).then(() => {
        // 显示复制成功状态
        const originalText = btn.querySelector('span').textContent;
        btn.querySelector('span').textContent = langTexts[isChinese ? 'zh' : 'en'].copiedBtn;
        btn.classList.add('copied');
        
        // 3秒后恢复原状
        setTimeout(() => {
          btn.querySelector('span').textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('复制失败', err);
        showError(isChinese ? '复制失败，请手动复制' : 'Copy failed, please copy manually');
      });
    }

    // 事件监听
    document.addEventListener('DOMContentLoaded', () => {
      // 加载聊天历史
      loadConversationHistory();
      
      // 初始化设置面板
      initSettingsPanel();
      
      // 发送消息
      sendBtn.addEventListener('click', sendMessage);
      
      // 停止生成
      stopBtn.addEventListener('click', stopGeneration);
      
      // 输入框调整
      userInput.addEventListener('input', adjustTextareaHeight);
      
      // 按Enter发送消息，按Shift+Enter换行
      userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // 设置面板控制
      settingsBtn.addEventListener('click', () => {
        animateSettingsPanel(true);
        initSettingsPanel();
      });
      
      closeSettings.addEventListener('click', () => {
        animateSettingsPanel(false);
      });
      
      saveSettings.addEventListener('click', saveSettingsHandler);
      
      // 点击设置面板外部关闭
      settingsPanel.addEventListener('click', (e) => {
        if (e.target === settingsPanel) {
          animateSettingsPanel(false);
        }
      });
      
      // 语言切换
      langBtn.addEventListener('click', toggleLanguage);
      
      // 清空对话上下文
      clearContextBtn.addEventListener('click', clearConversationContext);
      
      // 复制代码按钮
      document.addEventListener('click', (e) => {
        if (e.target.closest('.copy-btn')) {
          const btn = e.target.closest('.copy-btn');
          copyCodeToClipboard(btn);
        }
      });
    });
  </script>
</body>

</html>
